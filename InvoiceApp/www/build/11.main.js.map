{"version":3,"sources":["../../src/pages/work/stk-check-input/stk-check-input.module.ts","../../src/pages/work/stk-check-input/stk-check-input.ts"],"names":[],"mappings":"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","file":"11.main.js","sourcesContent":["import { NgModule } from '@angular/core';\r\nimport { IonicPageModule } from 'ionic-angular';\r\nimport { StkCheckInputPage } from './stk-check-input';\r\n\r\n@NgModule({\r\n    declarations: [\r\n        StkCheckInputPage,\r\n    ],\r\n    imports: [\r\n        IonicPageModule.forChild(StkCheckInputPage),\r\n    ],\r\n    exports: [\r\n        StkCheckInputPage\r\n    ]\r\n})\r\nexport class StkCheckInputPageModule {}\n\n\n// WEBPACK FOOTER //\n// ./src/pages/work/stk-check-input/stk-check-input.module.ts","import { Component } from '@angular/core';\r\nimport {IonicPage, NavController, NavParams,  ModalController } from 'ionic-angular';\r\nimport { SqlService } from '../../../providers/sql-service';\r\nimport { UtilService } from '../../../providers/util-service';\r\nimport { StkService } from '../../../providers/stk-service';\r\n/*\r\n  盘点录入单\r\n  wudefeng\r\n  2017-05-12\r\n*/\r\n@IonicPage()\r\n@Component({\r\n  selector: 'page-stk-check-input',\r\n  templateUrl: 'stk-check-input.html'\r\n})\r\nexport class StkCheckInputPage {\r\n\r\n  item: any = {};         //主表对象\r\n  checkList: any[] = [];  //从表对象\r\n  isAdd: boolean = true;  //是否新增 \r\n  parentPage: any;\r\n\r\n  constructor(\r\n    public navCtrl: NavController,\r\n    public navParams: NavParams,   \r\n    public sqlHelp: SqlService,\r\n    public util: UtilService,\r\n    public stk: StkService,\r\n    public modalCtrl: ModalController\r\n  ) { }\r\n\r\n  ionViewDidLoad() {\r\n    let obj = this.navParams.get(\"item\"), sql;\r\n    this.parentPage = this.navParams.get(\"parentPage\");\r\n    if (obj) {\r\n      this.item = obj;\r\n      sql = `select a.*,b.good_name,b.img from bl_stk_check_dtl a \r\n             join good b on a.good_no=b.good_no where bill_no=?`;\r\n      this.sqlHelp.getRowsBySql(sql, [obj.bill_no]).then(data => {\r\n        this.checkList = [].concat(data);       \r\n      });\r\n      this.isAdd = false;\r\n    } else {\r\n      this.sqlHelp.getCodeNo(\"PD\").then(no => {\r\n        this.item.bill_no = no;\r\n      });\r\n      this.item.bill_status = \"10\";\r\n    }\r\n  }\r\n\r\n  inputQty(obj: any) {\r\n\r\n    if (!this.isAdd) return;\r\n\r\n    let qty = obj.input_qty;\r\n    if (typeof qty == undefined) {\r\n      qty = \"\";\r\n    }\r\n\r\n    this.util.showPrompt('系统数量为:' + obj.stk_qty, '输入数量', [{ name: 'qty', placeholder: '输入实际盘点数量', type: 'number', value: qty }], data => {\r\n\r\n      if (data.qty == \"\") {\r\n        console.dir(\"盘点数量必须录入\");\r\n        return false;\r\n      }     \r\n      obj.input_qty = data.qty;\r\n    });\r\n  } \r\n\r\n  saveCheck() {\r\n    let msg = \"\";\r\n    if (!this.item.store_no) {\r\n      msg = \"请选择仓库\";\r\n    }   \r\n\r\n    if (this.getInputCount() < 1) {\r\n      msg = \"没有盘点项需保存\";\r\n    }\r\n\r\n    if (msg.length > 0) {\r\n      this.util.showAlert(msg);\r\n      return;\r\n    }\r\n  \r\n    let inputList = [];\r\n    for (let obj of this.checkList) {\r\n      if (obj.hasOwnProperty(\"input_qty\")) {\r\n        inputList.push({\r\n          id: obj.id || null,\r\n          bill_no: this.item.bill_no,\r\n          good_no: obj.good_no,\r\n          cost: obj.cost,\r\n          stk_qty: obj.stk_qty,\r\n          input_qty: obj.input_qty\r\n        });\r\n      }\r\n    }  \r\n\r\n    let checkObj = {\r\n      bill_no: this.item.bill_no,\r\n      bill_status: '10',\r\n      store_no: this.item.store_no,\r\n      creator: this.util.loginUser,\r\n      create_time: this.util.getNowFormatDate().substr(0, 10)\r\n    };\r\n\r\n    this.util.showConfirm(\"确认对录入的\" + inputList.length + \"项进行盘点?\", \"\", () => {\r\n      this.sqlHelp.saveBill(\"bl_stk_check\", checkObj, \"bl_stk_check_dtl\", inputList).then(result => {\r\n        this.stk.stkBiz(this.item.bill_no, \"1005\").then(() => {\r\n          this.parentPage && this.parentPage.getData && this.parentPage.getData(true);\r\n          this.navCtrl.pop();\r\n        });       \r\n      }).catch(error => {\r\n        console.error(error.err.message);\r\n      })\r\n    })\r\n  }\r\n\r\n  chooseStore() {\r\n    //当已录入了盘点数量，不能更改仓库\r\n    if (this.getInputCount() >0 || this.item.bill_status==\"20\") { return; }\r\n\r\n    let storepage = this.modalCtrl.create('DepotListPage', { isChoose: true });\r\n    storepage.onDidDismiss(store => {\r\n      if (store) {\r\n        this.item.store_no = store.store_no;\r\n        this.item.store_name = store.store_name;\r\n        //加载商品库存\r\n        let sql = `select a.good_no,a.good_name,a.img,a.cost_price as cost,ifnull(b.qty,0) as stk_qty \r\n                   from good a  join stk b on a.good_no=b.good_no\r\n                   where 1=1 and b.store_no=? union all\r\n                   select a.good_no,a.good_name,a.img,a.cost_price as cost,0 as stk_qty \r\n                   from good a  where not exists(select 1 from stk b where a.good_no=b.good_no and b.store_no=?)`;\r\n        this.sqlHelp.getRowsBySql(sql,[store.store_no,store.store_no]).then(rows => {\r\n          this.checkList = [].concat(rows);\r\n        });\r\n      }\r\n    });\r\n    storepage.present();\r\n  }\r\n\r\n  getInputCount() {\r\n    return this.checkList.filter(item => { return item.hasOwnProperty(\"input_qty\") }).length;\r\n  }\r\n\r\n  getTotalCost() {\r\n    let cost = 0;\r\n    for (let item of this.checkList) {\r\n      if (item.hasOwnProperty(\"input_qty\")) {\r\n        cost += (item.input_qty - item.stk_qty) * item.cost\r\n      }\r\n    }\r\n    return cost;\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/work/stk-check-input/stk-check-input.ts"],"sourceRoot":""}